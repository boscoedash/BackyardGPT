name: Deploy Azure Functions Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: landscaping-ai-functions
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './backend'
  NODE_VERSION: '20.x'
  RESOURCE_GROUP: landscaping-ai-rg

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Ensure public npm registry
      run: |
        npm config set registry https://registry.npmjs.org/

    # Install Azure Functions Core Tools without npm (avoids registry/auth issues)
    - name: Install Azure Functions Core Tools (apt)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y azure-functions-core-tools-4 || true
        func --version || echo "Core Tools not available via apt on runner"

    # Fallback: download Core Tools from GitHub releases if apt failed
    - name: Install Azure Functions Core Tools (fallback)
      if: ${{ failure() }}
      run: |
        wget -q https://github.com/Azure/azure-functions-core-tools/releases/download/4.0.5455/Azure.Functions.Cli.linux-x64.4.0.5455.zip
        unzip -q Azure.Functions.Cli.linux-x64.4.0.5455.zip -d Azure.Functions.Core.Tools
        echo "${PWD}/Azure.Functions.Core.Tools" >> $GITHUB_PATH
        func --version

    - name: Install dependencies
      run: |
        cd backend
        # Use npm install to avoid lockfile requirement on CI
        npm install --omit=dev

    - name: Create deployment package
      run: |
        cd backend
        mkdir -p deploy
        
        # Copy function files
        cp -r functions deploy/
        
        # Copy shared modules if they exist
        if [ -d "shared" ]; then
          cp -r shared deploy/
        fi
        
        # Copy configuration files
        cp package.json package-lock.json host.json deploy/
        
        # Copy node_modules
        cp -r node_modules deploy/
        
        # Create zip
        cd deploy
        zip -r ../deploy.zip ./*
        cd ..
        
        # Cleanup temp directory
        rm -rf deploy

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/deploy.zip

    - name: Wait for deployment sync
      run: |
        echo "Waiting for function app to sync..."
        sleep 30

    - name: Verify deployment
      run: |
        echo "Listing deployed functions..."
        az functionapp function list \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --query "[].{Name:name, Trigger:properties.config.bindings[0].type}" \
          --output table || echo "Function list command failed, but deployment may still be successful"

    - name: Test health endpoint
      run: |
        echo "Testing function app health..."
        FUNCTION_URL="https://${AZURE_FUNCTIONAPP_NAME}.azurewebsites.net"
        curl -f "${FUNCTION_URL}" || echo "Health check failed or not configured"

    - name: Cleanup
      if: always()
      run: |
        cd backend
        rm -f deploy.zip
        az logout || true
