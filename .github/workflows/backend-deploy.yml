name: Deploy Azure Functions Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: landscaping-ai-functions
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './backend'
  NODE_VERSION: '20.x'
  RESOURCE_GROUP: landscaping-ai-rg

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      run: |
        cd backend
        npm ci --production

    - name: Create deployment package
      run: |
        cd backend
        mkdir -p deploy
        
        # Copy function files
        cp -r functions deploy/
        
        # Copy shared modules if they exist
        if [ -d "shared" ]; then
          cp -r shared deploy/
        fi
        
        # Copy configuration files
        cp package.json package-lock.json host.json deploy/
        
        # Copy node_modules
        cp -r node_modules deploy/
        
        # Create zip
        cd deploy
        zip -r ../deploy.zip ./*
        cd ..
        
        # Cleanup temp directory
        rm -rf deploy

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/deploy.zip

    - name: Wait for deployment sync
      run: |
        echo "Waiting for function app to sync..."
        sleep 30

    - name: Verify deployment
      run: |
        echo "Listing deployed functions..."
        az functionapp function list \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --query "[].{Name:name, Trigger:properties.config.bindings[0].type}" \
          --output table || echo "Function list command failed, but deployment may still be successful"

    - name: Test health endpoint
      run: |
        echo "Testing function app health..."
        FUNCTION_URL="https://${AZURE_FUNCTIONAPP_NAME}.azurewebsites.net"
        curl -f "${FUNCTION_URL}" || echo "Health check failed or not configured"

    - name: Cleanup
      if: always()
      run: |
        cd backend
        rm -f deploy.zip
        az logout || true
