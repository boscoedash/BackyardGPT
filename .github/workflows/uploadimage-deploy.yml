name: Deploy UploadImage Function

on:
  push:
    branches:
      - main
    paths:
      - 'backend/functions/UploadImage/**'
      - 'backend/host.json'
      - '.github/workflows/uploadimage-deploy.yml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Publish to Azure Functions
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js (for Azure Functions Core Tools)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Azure Functions Core Tools
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Prepare Python package
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          STAGE="${{ runner.temp }}/uploadimage-function"
          rm -rf "$STAGE"
          mkdir -p "$STAGE"

          cp backend/host.json "$STAGE/host.json"
          cp -R backend/functions/UploadImage "$STAGE/UploadImage"
          cp backend/functions/UploadImage/requirements.txt "$STAGE/requirements.txt"

          python -m pip install --upgrade pip
          pip install -r "$STAGE/requirements.txt" -t "$STAGE/.python_packages/lib/site-packages"

          echo "stage_dir=$STAGE" >> "$GITHUB_OUTPUT"

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy UploadImage function
        shell: bash
        run: |
          set -euo pipefail
          APP_NAME='${{ secrets.AZURE_FUNCTIONAPP_NAME }}'
          if [ -z "$APP_NAME" ]; then
            echo "AZURE_FUNCTIONAPP_NAME secret is not configured." >&2
            exit 1
          fi
          pushd "${{ steps.prep.outputs.stage_dir }}"
          func azure functionapp publish "$APP_NAME" --python --no-build
          popd

      - name: Upload deployment artifact
        if: ${{ always() && steps.prep.outcome == 'success' && steps.prep.outputs.stage_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: uploadimage-function-package
          path: ${{ steps.prep.outputs.stage_dir }}
